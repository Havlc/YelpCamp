const fs = require('fs');
const path = require('path');
const rimraf = require('../utils/rimraf');

class FileKeyValueStorage {
<<<<<<< HEAD
  constructor({ baseFolder } = {}) {
=======
  constructor({baseFolder} = {}) {
>>>>>>> e850dbdd69512603c0d4d12d8d93e241262e32af
    this.init(baseFolder);
  }

  init(baseFolder) {
    if (baseFolder) {
<<<<<<< HEAD
      try {
        fs.accessSync(baseFolder);
        this.baseFolder = baseFolder;
      } catch (err) {
        throw err;
      }
    } else {
      if (!fs.existsSync('test_cache')) {
=======
      fs.access(baseFolder, (err, result) => {
        if (err) throw err;
        this.baseFolder = baseFolder;
      });
    } else {
      if(!fs.existsSync('test_cache')) {
>>>>>>> e850dbdd69512603c0d4d12d8d93e241262e32af
        fs.mkdirSync('test_cache');
      }
      this.baseFolder = fs.mkdtempSync('test_cache/cloudinary_cache_');
      console.info("Created temporary cache folder at " + this.baseFolder);
    }
  }

  get(key) {
    let value = fs.readFileSync(this.getFilename(key));
    try {
      return JSON.parse(value);
<<<<<<< HEAD
    } catch (e) {
=======
    } catch(e) {
>>>>>>> e850dbdd69512603c0d4d12d8d93e241262e32af
      throw "Cannot parse cache value";
    }
  }

  set(key, value) {
    fs.writeFileSync(this.getFilename(key), JSON.stringify(value));
  }

  clear() {
    let files = fs.readdirSync(this.baseFolder);
<<<<<<< HEAD
    files.forEach(file => fs.unlinkSync(path.join(this.baseFolder, file)));
=======
    for(let file of files) {
      fs.unlinkSync(path.join(this.baseFolder, file));
    }
>>>>>>> e850dbdd69512603c0d4d12d8d93e241262e32af
  }

  deleteBaseFolder() {
    rimraf(this.baseFolder);
  }

  getFilename(key) {
<<<<<<< HEAD
    return path.format({ name: key, base: key, ext: '.json', dir: this.baseFolder });
  }
}

module.exports = FileKeyValueStorage;
=======
    return path.format({name: key, base: key, ext: '.json', dir: this.baseFolder});
  }

}

module.exports = FileKeyValueStorage;
>>>>>>> e850dbdd69512603c0d4d12d8d93e241262e32af
