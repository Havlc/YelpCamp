<<<<<<< HEAD
let PRELOADED_CLOUDINARY_PATH, config, utils;
=======
var PRELOADED_CLOUDINARY_PATH, config, utils;
>>>>>>> e850dbdd69512603c0d4d12d8d93e241262e32af

utils = require("./utils");

config = require("./config");

PRELOADED_CLOUDINARY_PATH = /^([^\/]+)\/([^\/]+)\/v(\d+)\/([^#]+)#([^\/]+)$/;

class PreloadedFile {
  constructor(file_info) {
<<<<<<< HEAD
    let matches, public_id_and_format;
=======
    var matches, public_id_and_format;
>>>>>>> e850dbdd69512603c0d4d12d8d93e241262e32af
    matches = file_info.match(PRELOADED_CLOUDINARY_PATH);
    if (!matches) {
      throw "Invalid preloaded file info";
    }
    this.resource_type = matches[1];
    this.type = matches[2];
    this.version = matches[3];
    this.filename = matches[4];
    this.signature = matches[5];
<<<<<<< HEAD
    public_id_and_format = PreloadedFile.split_format(this.filename);
=======
    public_id_and_format = this.split_format(this.filename);
>>>>>>> e850dbdd69512603c0d4d12d8d93e241262e32af
    this.public_id = public_id_and_format[0];
    this.format = public_id_and_format[1];
  }

  is_valid() {
<<<<<<< HEAD
    let expected_signature;
=======
    var expected_signature, public_id;
    public_id = this.resource_type === "raw" ? this.filename : this.public_id;
>>>>>>> e850dbdd69512603c0d4d12d8d93e241262e32af
    expected_signature = utils.api_sign_request({
      public_id: this.public_id,
      version: this.version
    }, config().api_secret);
    return this.signature === expected_signature;
  }

<<<<<<< HEAD
  static split_format(identifier) {
    let format, last_dot, public_id;
=======
  split_format(identifier) {
    var format, last_dot, public_id;
>>>>>>> e850dbdd69512603c0d4d12d8d93e241262e32af
    last_dot = identifier.lastIndexOf(".");
    if (last_dot === -1) {
      return [identifier, null];
    }
    public_id = identifier.substr(0, last_dot);
    format = identifier.substr(last_dot + 1);
    return [public_id, format];
  }

  identifier() {
    return `v${this.version}/${this.filename}`;
  }

  toString() {
    return `${this.resource_type}/${this.type}/v${this.version}/${this.filename}#${this.signature}`;
  }

  toJSON() {
<<<<<<< HEAD
    let result = {};
=======
    var result = {};
>>>>>>> e850dbdd69512603c0d4d12d8d93e241262e32af
    Object.getOwnPropertyNames(this).forEach((key) => {
      let val = this[key];
      if (typeof val !== 'function') {
        result[key] = val;
      }
    });
    return result;
  }
<<<<<<< HEAD
=======

>>>>>>> e850dbdd69512603c0d4d12d8d93e241262e32af
}

module.exports = PreloadedFile;
